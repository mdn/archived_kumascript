<%
// Generates a table of the localization status for a given section
//
// Parameters:
//  $0  -  The slug to build the table for (e.g. "/en-us/docs/Web/JavaScript")
//  $1  -  The locale to check for the localization status
//  $2  -  (optional) Group tags. An array of tags to filter the section even more (only pages with these tags are included then; OR logic).

/* LOCALISATION STRINGS */
var l10nSummary = mdn.localString({
    "en-US": "Summary",
    "fr"   : "En bref"
});

var l10nDetails = mdn.localString({
    "en-US": "All articles",
    "fr"   : "Tous les articles"
});

var l10nPage = mdn.localString({
    "en-US": "Page"
});

var l10nPages = mdn.localString({
    "en-US": "Pages"
});
    
var l10nPriority = mdn.localString({
    "en-US": "Priority articles",
    "fr"   : "Articles prioritaires"
});
    
var l10nStateUnavailable = mdn.localString({
    "en-US": "Not available",
    "fr"   : "Indisponible"
});

var l10nStateUptodate = mdn.localString({
    "en-US": "Yes, and up to date",
    "fr"   : "Oui et à jour"
});

var l10nStateOutofdate = mdn.localString({
    "en-US": "Yes, but not up to date (#d# days older).",
    "fr"   : "Oui mais pas à jour (#d# jours d'écart)"
});
    
var l10nTranslated = mdn.localString({
    "en-US": "Translated",
    "fr"   : "Traduction"
});
    
var l10nUptodate = mdn.localString({
    "en-US": "Translations up to date",
    "fr"   : "Traductions à jour"
});

var section = $0;
var locale = $1;
var groupTags = [];
if ($2) {
    groupTags = JSON.parse($2);
}

var pageList = page.subpagesExpand(section);
var result = [];
var priorities = []
var translationCounter = 0;
var outdatedCounter = 0;
var priorityCounter = 0;

function collect(page) {
    result.push({title: page.title.replace('<','&lt;').replace('>','&gt;'), url: page.url, translations: page.translations, last_edit: page.last_edit})

    if (hasTranslation(page.translations, locale)) {
        translationCounter++;
    }
    var translation = getTranslation(page.translations, locale);
    if (isOutdated(page.last_edit, translation.last_edit)) {
        outdatedCounter++;
    }
    
    if (hasTags(page.tags, "l10n:priority")) {
        priorities.push({title: page.title.replace('<','&lt;').replace('>','&gt;'), url: page.url, translations: page.translations, last_edit: page.last_edit});
        priorityCounter++;
    }
}

function getPages(pageList) {
    if (pageList) {
        for (var i = 0; i < pageList.length; i++) {
            if (!hasTags(pageList[i].tags, "l10n:exclude")) {
                if (groupTags.length > 0) {
                    for (var j = 0; j < groupTags.length; j++) {
                        if (hasTags(pageList[i].tags, groupTags[j])) {
                            collect(pageList[i]);
                        }
                    }
                } else {
                    collect(pageList[i]);
                }
                
                var subpage = getPages(pageList[i].subpages);
            }
        }
    }
}

function isOutdated(enDate, l10nDate) {
    if (!enDate || typeof enDate == 'undefined' || !l10nDate || typeof l10nDate == 'undefined') return 0;
    if (new Date(l10nDate) < new Date(enDate)) return 1;
    return 0;
}

function daysBetween(date1, date2) {
  date1 = new Date(date1);
  date2 = new Date(date2);
  
  var aDay = 1000*60*60*24;

  var d1ms = date1.getTime();
  var d2ms = date2.getTime();
  var diff = d2ms - d1ms;
    
  return Math.round(diff/aDay); 
}

function hasTranslation(pageTranslations, locale) {
    if (!pageTranslations || typeof pageTranslations == 'undefined') return 0;
    for (var i = 0, len = pageTranslations.length; i < len; i++) {
        if (pageTranslations[i].locale == locale) return 1;
    }
    return 0;
}

function getTranslation(pageTranslations, locale) {
    if (!pageTranslations || typeof pageTranslations == 'undefined') return 0;
    for (var i = 0, len = pageTranslations.length; i < len; i++) {
        if (pageTranslations[i].locale == locale) return pageTranslations[i];
    }
    return 0;
}

function hasTags(tags, needle) {
    if (!tags || tags == undefined) return 0;
    for (var i = 0, len = tags.length; i < len; i++) {
        if (tags[i].toLowerCase() === needle.toLowerCase()) return 1;
    }
    return 0;
}

getPages(pageList);

var translationPercent = Math.ceil((translationCounter / result.length) * 100);
var uptodateCounter = translationCounter - outdatedCounter;
var uptodatePercent = Math.ceil((uptodateCounter / translationCounter) * 100);

if (isNaN(uptodatePercent)) { uptodatePercent = 0; }
%>
<h2 id="<%=l10nSummary.replace(" ","_")%>"><%=l10nSummary%></h2>
<table class="docstatussummary standard-table">
  <thead>
    <tr>
      <th><%=l10nPages%></th>
      <th><%=l10nTranslated%></th>
      <th><%=l10nUptodate%></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><%=result.length%></td>
      <td><%=translationCounter%> (<%=translationPercent%>%)</td>
      <td><%=uptodateCounter%> (<%=uptodatePercent%>%)</td>
    </tr>
  </tbody>
</table>
<% if (priorityCounter > 0) { %>
<h2 id="<%=l10nPriority.replace(" ","_")%>"><%=l10nPriority%></h2>
<table class="fullwidth-table standard-table">
<thead>
    <th><%=l10nPage%></th>
    <th><%=l10nTranslated%></th>
</thead>
<tbody>

<% for (i=0; i < priorities.length; i++) { %>
<tr>
    <td><a href='<%=priorities[i].url%>'><%=priorities[i].title%></a></td>
    <% if (hasTranslation(priorities[i].translations, locale)) {
        var translation = getTranslation(priorities[i].translations, locale);
        if (isOutdated(priorities[i].last_edit, translation.last_edit)) { 
            var days = daysBetween(translation.last_edit, priorities[i].last_edit); %>
            <td style="background-color: #FF9"><a href="<%=translation.url%>"><%=l10nStateOutofdate.replace("#d#",days)%></a></td>
        <% } else { %>
            <td style="background-color: #CF9"><a href="<%=translation.url%>"><%=l10nStateUptodate%></a></td>
        <% } %>
    <% } else { %>
        <td style="background-color: #FCC"><%=l10nStateUnavailable%></td>
    <% } %>
</tr>
<% } %>

</tbody>
</table>
<% } %>

<h2 id="<%=l10nDetails.replace(" ","_")%>"><%=l10nDetails%></h2>
<table class="fullwidth-table standard-table">
<thead>
    <th><%=l10nPage%></th>
    <th><%=l10nTranslated%></th>
</thead>
<tbody>

<% for (i=0; i < result.length; i++) { %>
<tr>
    <td><a href='<%=result[i].url%>'><%=result[i].title%></a></td>
    <% if (hasTranslation(result[i].translations, locale)) {
        var translation = getTranslation(result[i].translations, locale);
        if (isOutdated(result[i].last_edit, translation.last_edit)) { 
            var days = daysBetween(translation.last_edit, result[i].last_edit); %>
            <td style="background-color: #FF9"><a href="<%=translation.url%>"><%=l10nStateOutofdate.replace("#d#",days)%></a></td>
        <% } else { %>
            <td style="background-color: #CF9"><a href="<%=translation.url%>"><%=l10nStateUptodate%></a></td>
        <% } %>
    <% } else { %>
        <td style="background-color: #FCC"><%=l10nStateUnavailable%></td>
    <% } %>
</tr>
<% } %>

</tbody>
</table>

<%
var metrics = {
    pages: {
        title: 'Number of English pages',
        counter: result.length
    },
    translations: {
        title: 'Translations available',
        counter: translationCounter
    },
    updateNeeded: {
        title: 'Translations up to date',
        counter: uptodateCounter
    }
};
%>
<div id="json" style="display: none"><%=JSON.stringify(metrics) %></div>
