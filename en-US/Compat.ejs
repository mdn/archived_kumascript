<%

// If no arguments are given figure out which json belongs to the current page
// If arguments are given:
//    $0 – path to json, e.g. "web/http/headers.json"
//    $1 – feature to be queried, e.g. "Cache-Control"

var baseURL = "https://raw.githubusercontent.com/mdn/browser-compat-data/master/";
var currentSlug = env.slug;
var locale = env.locale;
var url = "";
var output = "";
var leaf = "";

// Adding "l10n" object since computed names (mdn.localString)
// cannot be used to build "map"

var mapL10n = {
    "en-US": {
       "Web/HTTP/Headers": "http/headers.json",
       "Web/HTTP/Methods": "http/methods.json",
       "Web/HTTP/Status" : "http/status.json",
       "Web/JavaScript/Reference/Global_Objects/Promise": "javascript/promise.json"
    },
    "fr"  : {
       "Web/HTTP/En-têtes": "http/headers.json",
       "Web/HTTP/Méthodes": "http/methods.json",
       "Web/HTTP/Statut"  : "http/status.json",
       "Web/JavaScript/Reference/Objets_globaux/Promise": "javascript/promise.json"
    }
};

var map = mapL10n[locale];

// We are on a main page, e.g.:
// Web/HTTP/Headers
// Web/JavaScript/Reference/Global_Objects/Object
// Web/API/WebGLRenderingContext
if (map.hasOwnProperty(currentSlug)) {
  url = baseURL + map[currentSlug];
} else {
  // We are on a leaf page, e.g.:
  // Web/HTTP/Headers/Cache-Control
  // Web/JavaScript/Reference/Global_Objects/Object/hasOwnProperty
  // Web/API/WebGLRenderingContext/texImage2D
  var parentSlug = currentSlug.substring(0, currentSlug.lastIndexOf('/'));
  if (map.hasOwnProperty(parentSlug)) {
    url = baseURL + map[parentSlug];
    leaf = env.title.replace('()', '');
  }
}

if ($0) {
  url = baseURL + $0;
  if ($1) {
    leaf = $1;
  }
}


if (url !== "") {
  var data = mdn.fetchJSONResource(url);
  if (leaf !== "") {
    output = template("CompatDataTable", [data[leaf], "api"]);
  } else {
    output = template("CompatDataTable", [data, "module"]);
  }
} else {
  output = "No compat data found."
}

%>
<%-output%>
