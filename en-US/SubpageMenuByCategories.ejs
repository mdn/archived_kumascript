<%
// Generate the menu for the a landing page. This page is divided
// up into various categories using the pages' tags. Once that's done,
// any remaining pages are put into a "miscellaneous" group.
//
// Parameters:
//
//  $0  JSON object defining the categories
//
// Category object contains an array of objects describing each category;
// the categories are defined by the tag used to identify them and a name
// used as the heading in the menu.
//
// "[{'tag': 'tagname', 'name': 'categoryname'}, ...]"

//
// hasTag
//
// Returns true if the specified page has the indicated tag.
//
function hasTag(aPage, aTag) {
    if (aPage.tags == undefined || aPage.tags == null || aPage.tags.length == 0) {
        return false;
    }
    
    for (var i=0; i<aPage.tags.length; i++) {
        if (aPage.tags[i] == aTag) {
            return true;
        }
    }
    
    return false;
}

var categoryList = JSON.parse($0);
var html = "";

// Get a list of all subpages of the current page. This is, by default,
// our list of "miscellaneous" pages. We'll then pull pages out of that
// list as we move them into others by category.

var miscPages = page.subpagesExpand(env.path, 1, 0);
var numPages = miscPages.length;

for (var i=0; i<categoryList.length; i++) {
    var category = categoryList[i];
    var resultList = [];
    
    html += "<h2>" + category.name + "</h2>";
    
    for (var j=0; j<numPages; j++) {
        if (hasTag(miscPages[j], category.tag)) {
            resultList.push(miscPages[j]);
            miscPages.splice(j, 1);
            j--;
            numPages--;
        }
    }
    
    html += template("SubpagesWithSummaries", [JSON.stringify(resultList)]);
}

// Output the misc pages

html += "<h2 id='Other'>Other pages</h2>" + template("SubpagesWithSummaries", [JSON.stringify(miscPages)]);
%>
<%-html%>
