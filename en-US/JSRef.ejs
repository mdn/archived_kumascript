<%
// Generate quick links for JavaScript reference docs
//
// TODO: Highlight or remove the link for the page you are currently on (?)
// TODO: Ordering of prototype / static methods (bug 948576)
//
// Parameters:
//
//  $0 - JavaScript reference section (e.g Global_Objects) – OBSOLETE
//  $1 - JavaScript reference object/subject (e.g. Number, Array, Function) – OBSOLETE
//  $2 - Related objects to display (comma separated)
// 
// Example: {{JSRef("Global_Objects", "Number")}} 
// Includes quicklinks for the Number object including all methods and properties
// and also includes inherited methods/properties from Object and Function

// Strings
var commonl10n = string.deserialize(template('L10n:Common'));
var jsl10n = string.deserialize(template('L10n:JavaScript'));

var text = {
    'refslug': mdn.getLocalString(jsl10n, 'slug_reference'),
    'stdlibslug': mdn.getLocalString(jsl10n, 'slug_global_objects'),
    'stdlib': mdn.getLocalString(jsl10n, 'stdlib'),
    'Properties': mdn.getLocalString(commonl10n, 'Properties'),
    'Methods': mdn.getLocalString(commonl10n, 'Methods'),
    'Inheritance': mdn.getLocalString(commonl10n, 'Inheritance'),
    'Related': mdn.getLocalString(commonl10n, 'Related_pages_wo_group'),
};

// Variables
var containsTag = page.hasTag;
var escapeQuotes = mdn.escapeQuotes;
var slug = env.slug;
var locale = env.locale;
var slug_stdlib = '/' + env.locale + '/docs/Web/JavaScript/' + text['refslug'] + text['stdlibslug'];
var mainObj = slug.replace('Web/JavaScript/' + text['refslug'] + text['stdlibslug'], '').split('/')[0];

// Data for inheritance chain
var inheritance = ["Object", "Function"];
var inheritanceData = {
    "Math": ["Object"],
    "Function": ["Object"],
    "Object": ["Function"],
    "JSON": ["Object"],
    "Intl": ["Object"],
    "arguments": [],
    "Reflect": ["Object"],
};
if (typeof inheritanceData[mainObj] != 'undefined') {
    inheritance = inheritanceData[mainObj];
}

// Data for related pages
// TBD


// Collect pages
var source = {};
source[mainObj] = page.subpagesExpand(slug_stdlib + mainObj);
if  (inheritance.indexOf("Function") > -1) {
    source["iFunction"] = page.subpagesExpand(slug_stdlib + 'Function');
}
if  (inheritance.indexOf("Object") > -1) {
    source["iObject"] = page.subpagesExpand(slug_stdlib + 'Object');
}

var result = {};
result[mainObj] = {
    title: mainObj,
    methods: [],
    properties: [],
    defaultOpened: true
};
if  (inheritance.indexOf("Function") > -1) {
result['iFunction'] = {
    title: 'Function',
    methods: [],
    properties: [],
    defaultOpened: false
};
}
if  (inheritance.indexOf("Object") > -1) {
result['iObject'] = {
    title: 'Object',
    methods: [],
    properties: [],
    defaultOpened: false
};
}

var pageList, isObj, includeme;

for (var object in source) {
    pageList = source[object];
    if (object == "iObject") {
        isObj = true;
    }
    for (aPage in pageList) {
        if (isObj) {
            includeme = containsTag(pageList[aPage], "prototype");
        } else {
            includeme = true;
        }
        if (containsTag(pageList[aPage], result[object].title) && containsTag(pageList[aPage], 'Property') && includeme) {
            result[object].properties.push(pageList[aPage]);
        }
        if (containsTag(pageList[aPage], result[object].title) && containsTag(pageList[aPage], 'Method') && includeme) {
            result[object].methods.push(pageList[aPage]);
        } 
    }
}

// Output helper

var badges = {
  ExperimentalBadge : '<span class="sidebar-icon">' + template("ExperimentalBadge", [1]) + '</span>',
  NonStandardBadge  : '<span class="sidebar-icon">' + template("NonStandardBadge", [1]) + '</span>',
  DeprecatedBadge   : '<span class="sidebar-icon">' + template("DeprecatedBadge", [1]) + '</span>',
  ObsoleteBadge     : '<span class="sidebar-icon">' + template("ObsoleteBadge", [1]) + '</span>',
}

function buildSublist(pages, title, opened) {
  var result = '<li>';
  if (opened) {
    result = '<li data-default-state="open">';
  }
  result += '<a href="#"><strong>' + title + '</strong></a><ol>';

  for (var i in pages) {
    var aPage = pages[i];
    result += '<li>';
    
    if (containsTag(aPage, 'Experimental')) {
        result += badges.ExperimentalBadge;
    }

    if (containsTag(aPage, 'Non-standard') || containsTag(aPage, 'Non Standard')) {
        result += badges.NonStandardBadge;
    }

    if (containsTag(aPage, 'Deprecated')) {
        result += badges.DeprecatedBadge;
    }

    if (containsTag(aPage, 'Obsolete')) {
        result += badges.ObsoleteBadge;
        result += '<s class="obsoleteElement">';
    }
    
    if (rtlLocales.indexOf(locale) != -1) {
        result += '<bdi>';
    }
    
    if (slug == aPage.slug) {
        result += '<em><code>' + aPage.title + '</code></em>'
    } else {
        result += '<a href="' + aPage.url.replace('en-US', locale) + '" title="' + escapeQuotes(aPage.summary) + '"><code>' + aPage.title + '</code></a>';
    }
    
    if (rtlLocales.indexOf(locale) != -1) {
        result += '</bdi>';
    }
    
    if (containsTag(aPage, 'Obsolete')) {
        result += '</s>';
    }
    
    result += '</li>';
  }

  result += '</ol></li>';

  return result;
}


var resultTitle,
resultProperties,
resultMethods,
resultOpen,
len = 0;

// Output

var output  = '<section class="Quick_links" id="Quick_Links"><ol>';
    output += '<li><strong><a href="'+slug_stdlib+'">'+text['stdlib']+'</a></strong></li>';

    for (object in result) {
        len++;
        resultTitle      = result[object].title || '';
        resultProperties = result[object].properties || '';
        resultMethods    = result[object].methods || '';
        resultOpen       = result[object].defaultOpened || '';

        if (len == 2) {
          output += '<li><strong>'+text['Inheritance']+'</strong></li>';
        }

        output += '<li><strong><a href="'+slug_stdlib + resultTitle +'"><code>'+resultTitle+'</code></a></strong></li>';

        if (resultProperties.length > 0) {
          output += buildSublist(resultProperties, text['Properties'], resultOpen);
        }
        if (resultMethods.length > 0) {
          output += buildSublist(resultMethods, text['Methods'], resultOpen);
        }

        if (len == 1 && $2) {
            output += '<li><strong>'+text['Related']+'</strong></li>';
            var arr = $2.split(",");
            for (var i = 0; i <  arr.length; i++) {
              output += '<li><strong><a href="'+slug_stdlib + arr[i]+'"><code>'+arr[i]+'</code></a></strong></li>';
            }
        }

    }

output += '</ol></section>';
%>

<%-output%>
