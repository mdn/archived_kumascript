<% var MDN = module.exports = {
    
    /**
     * Given a set of strings like this:
     *     { "en-US": "Foo", "de": "Bar", "es": "Baz" }
     * Return the one which matches the current locale.
     */
    localString: function (strings) {
        var lang = env.locale;
        if (!(lang in strings)) lang = 'en-US';
        return strings[lang];
    },
    
    /**
     * Given a string, escapes all quotes within it.
     */
    escapeQuotes: function(a) {
        var b = "";
        for (var i = 0, len = a.length; i < len; i++) {
            var c = a[i];
            if (c=="\"") c = "&quot;";
            b += c;
        }
        return b.replace(/(<([^>]+)>)/ig, "");
    },

    /**
     * Accepts a relative URL or an attachment object
     * Returns the content of a given file.
     */
    getFileContent: function(fileObjOrUrl) {
        var url = fileObjOrUrl.url || fileObjOrUrl;
        if(!url) return '';
        
        var result = '',
            base_url = '';
        
        // New file urls include attachment host, so we don't need to prepend it
        var fUrl = kuma.url.parse(url);
        if (!fUrl.host) {
            var p = kuma.url.parse(env.url, true),
                base_url = p.protocol + '//' + p.host;
        }
        url = base_url + url;
        return cacheFn('kuma:get_attachment_content:' + md5(url.toLowerCase()), 3600, function(next) {
            try {
                request({
                    method: 'GET',
                    headers: { 'Cache-Control': env.cache_control },
                    url: url
                }, function(err, resp, body) {
                    if(resp && 200 == resp.statusCode) {
                        next(body);
                    }
                    else if(err) {
                        next(null);
                    }
                });
            } catch(e) {
                next("error: " + e);
            }
        });
    },

    /**
     * #### cacheFnIgnoreCacheControl
     * Cache a function, and use cached results no matter what 
     * Cache-Control we get from a shift-refresh.
     */
    cacheFnIgnoreCacheControl: function (key, tm_out, to_cache) {
        var result = null,
            err_result = null,
            f = new Future(),
            mc = memcached;
        mc.get(key, function (err, c_result) {
            if (c_result) {
                result = c_result;
                f['return']();
            } else {
                try {
                    to_cache(function (val) {
                        mc.set(key, val, tm_out, function (err, c_result) {
                            result = val;
                            f['return']();
                        });
                    });
                } catch (e) {
                    err_result = e;
                    result = '';
                    f['return']();
                }
            }
        });
        f.wait();
        if (err_result) { throw err_result; }
        return result;
    },
        
    // #### fetchJSONResource
    // Fetch an HTTP resource with JSON representation, parse the JSON and 
    // return a JS object.
    fetchJSONResource: function (url, cache_tmout, key, ignore_cache_control, opts) {
        var key = 'kuma:json_resource:' + md5(url.toLowerCase());
        var opts = {
            method: 'GET',
            headers: { 'Cache-Control': env.cache_control, 
                       'Accept': 'application/json',
                       'Content-Type': 'application/json' },
            url: url
        };
        var data = MDN.fetchHTTPResource(url, cache_tmout, key, ignore_cache_control, opts);
        return JSON.parse(data);
    },

    // #### fetchHTTPResource
    // Fetch an HTTP resource, return the response body.
    fetchHTTPResource: function (url, cache_tmout, key, ignore_cache_control, opts) {
        if (!cache_tmout) cache_tmout = 3600;
        key = key || 'kuma:http_resource:' + md5(url.toLowerCase());
        var to_cache = function (next) {
            opts = opts || {
                method: 'GET',
                headers: { 'Cache-Control': env.cache_control },
                url: url
            };
            try {
                var req = request.get(opts);
                req.on('response', function(res) {
                    var chunks = [];
                    var content_length = 0;
                    res.on('error', function(chunk) {
                        next(null);
                    });
                    res.on('data', function(chunk) {
                        chunks.push(chunk);
                        content_length += chunk.length;
                    });
                    res.on('end', function() {
                        var buffer = new Buffer(content_length);
                        var offset = 0;
                        for (var i=0; i<chunks.length; i++) {
                            chunks[i].copy(buffer, offset);
                            offset += chunks[i].length;
                        }
                        if (opts.debug) log.debug("HEADERS " + kuma.inspect(res.headers));
                        var encoding = res.headers['content-encoding'];
                        if (encoding == 'gzip') {
                            zlib.gunzip(buffer, function(err, decoded) {
                                next(decoded && decoded.toString());
                            });
                        } else if (encoding == 'deflate') {
                            zlib.inflate(buffer, function(err, decoded) {
                              next(decoded && decoded.toString());
                            })
                        } else {
                            next(buffer.toString());
                        }
                    });
                });                 
                req.on('error', function(err) { next(null); });                
            } catch (e) {
                next(null);
            }            
        };
        if (ignore_cache_control) {
            return MDN.cacheFnIgnoreCacheControl(key, cache_tmout, to_cache);
        } else {
            return cacheFn(key, cache_tmout, to_cache);
        }
    },
    
    /* Returns the appropriate string (usually a comma+space) for usage in a enumeration list for the current locale */
    listSeparator: function() {
        var listSeparators = { "en-US": ", ", "ar": "،", "fa": "،", "ja": "、", "ko": "·", "mn": "᠂", "ur": "،", "zh−TW": "、" };
        return mdn.localString(listSeparators);
    }
} %>
